<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta name="theme-color" content="#062F4F"/>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.2" />

    
    
    

<title>Floating Point Hell • Morgan Creekmore</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Floating Point Hell"/>
<meta name="twitter:description" content="This blog post will show how to deal with floating-point error in JavaScript by encoding all uint64&rsquo;s, and int64&rsquo;s as strings in JSON Marshaling."/>

<meta property="og:title" content="Floating Point Hell" />
<meta property="og:description" content="This blog post will show how to deal with floating-point error in JavaScript by encoding all uint64&rsquo;s, and int64&rsquo;s as strings in JSON Marshaling." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://morgancreekmore.me/posts/floating-point-hell/" />
<meta property="article:published_time" content="2014-03-16T13:33:19-05:00"/>
<meta property="article:modified_time" content="2014-03-16T13:33:19-05:00"/>


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.f1d33a175a0891cb1bc3d360dfc2ea3618ceeaa95657e503f46599ce385b5c54.css" integrity="sha256-8dM6F1oIkcsbw9Ng38LqNhjO6qlWV&#43;UD9GWZzjhbXFQ=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <link rel="stylesheet" href="/css/custom.css">
    <!-- Font-Awesome -->	
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class="theme-base-darkblue ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://morgancreekmore.me/">Morgan Creekmore</a>
      </span>
      
      
      <p class="site__description">
         Doing Stuff 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Morgan Creekmore</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/projects/">
						<span>Projects</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/search/">
						<span>Search</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/gamingrobot" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/gamingrobot" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/morgancreekmore" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/1161491" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://keybase.io/gamingrobot" rel="me"><i class="fab fa-keybase fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:morgan@creekmore.email" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    
  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Floating Point Hell</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 16, 2014
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 2 min read
</div>


  </header>
  
  
  <div class="post">
    <p>This blog post will show how to deal with floating-point error in JavaScript by encoding all uint64&rsquo;s, and int64&rsquo;s as strings in JSON Marshaling.</p>

<p>JavaScript has 53-bits of integer precision, this is a problem when trying to represent a 64-bit number. Ways of solving this in JavaScript is to use <a href="https://v8project.blogspot.com/2018/05/bigint.html">bigint</a> or <a href="http://mathjs.org/">math.js</a>, but when parsing JSON we can&rsquo;t use this.</p>

<hr />

<h2 id="when-it-goes-wrong">When it goes wrong</h2>

<p>This is an example of how it can go wrong. Go encodes the JSON correctly, but when parsed by JavaScript the number does not match.</p>

<h3 id="go">Go</h3>

<p>Base data structure</p>

<pre><code class="language-go">type LargeId uint64

type Data struct {
    Id      LargeId
    BigNum int64
}
</code></pre>

<p>Encode and Decode data</p>

<pre><code class="language-go">data := Data{Id: 12345678901234567892, BigNum: 12000000000002539}
output, _ := json.Marshal(data)
fmt.Println(&quot;Data -&gt; Json&quot;, string(output))
input := string(output)
output2 := Data{}
json.Unmarshal([]byte(input), &amp;output2)
fmt.Printf(&quot;Json -&gt; Data %+v\n&quot;, output2)

//Output
Data -&gt; Json {&quot;Id&quot;:12345678901234567892,&quot;BigNum&quot;:12000000000002539}
Json -&gt; Data {Id:12345678901234567892 BigNum:12000000000002539}
</code></pre>

<p>As you can see Go has no problem encoding and decoding the large integers. But let&rsquo;s see what happens when JavaScript tries to decode the same integers.</p>

<h3 id="javascript">JavaScript</h3>

<pre><code class="language-javascript">var data = '{&quot;Id&quot;:12345678901234567892,&quot;BigNum&quot;:12000000000002539}'
console.log(JSON.parse(data))

//Output
Object {Id: 12345678901234567000, BigNum: 12000000000002540}
</code></pre>

<p>JavaScript ended up decoding the number, but its wrong. But if we check for equivalence in JavaScript it returns true.</p>

<pre><code class="language-javascript">&gt; 12000000000002539 === 12000000000002540
true
</code></pre>

<hr />

<h2 id="how-to-fix-it">How to fix it</h2>

<p>The easiest way to fix this is to encode the int64 to a string, that way when parsed in JavaScript the number is represented correctly.</p>

<p>Below I have added <code>json:&quot;,string&quot;</code> tag to the end of every int64, this tells the <code>encoding/json</code> package to encode that field as a string instead of an integer.</p>

<h3 id="go-1">Go</h3>

<p>Base data structure with tags</p>

<pre><code class="language-go">type LargeId uint64

type Data struct {
    Id      LargeId `json:&quot;,string&quot;`
    BigNum int64  `json:&quot;,string&quot;`
}
</code></pre>

<p>Encode and Decode data</p>

<pre><code class="language-go">data := Data{Id: 12345678901234567892, BigNum: 12000000000002539}
output, _ := json.Marshal(data)
fmt.Println(&quot;Data -&gt; Json&quot;, string(output))
input := string(output)
output2 := Data{}
json.Unmarshal([]byte(input), &amp;output2)
fmt.Printf(&quot;Json -&gt; Data %+v\n&quot;, output2)

//Output
Data -&gt; Json {&quot;Id&quot;:&quot;12345678901234567892&quot;,&quot;BigNum&quot;:&quot;12000000000002539&quot;}
Json -&gt; Data {Id:12345678901234567892 BigNum:12000000000002539}
</code></pre>

<p>With the tag we can encode and decode the JSON and keep the int64 type in Go.</p>

<h3 id="javascript-1">JavaScript</h3>

<pre><code class="language-javascript">var data = '{&quot;Id&quot;:&quot;12345678901234567892&quot;,&quot;BigNum&quot;:&quot;12000000000002539&quot;}'
console.log(JSON.parse(data))

//Output
Object {Id: &quot;12345678901234567892&quot;, BigNum: &quot;12000000000002539&quot;}
</code></pre>

<p>Now the number is represented correctly in JavaScript. This is useful if you are using the number as an identifier, but makes it difficult to do arithmetic operations on the number.</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/setup-qemu-for-arm-on-wheezy/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Setup QEMU for ARM on Wheezy</span>
    </a>
    
    
</div>


  

  
    
        <script src="https://utteranc.es/client.js"
        repo="gamingrobot/gamingrobot.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    


</article>


            <div class="copyright">
    &copy; 2019 Morgan Creekmore -
    <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a>
    <br/>Built with
    <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
    
</div>
        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-66010416-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/go.min.js"></script>
            
        
    
    <script type="text/javascript">
        
        hljs.configure({languages: ["go"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
